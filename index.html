<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<style>
body{
  margin:0;
  background:#000;
}

/* virtual scroll area */
.sequence{
  height:100vh;
}

canvas{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
}

/* text */
.title{
  position:fixed;
  top:40%;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  font-size:48px;
  font-weight:bold;
  opacity:0;
}
</style>
</head>

<body>

<section class="sequence">
  <canvas id="hero-lightpass"></canvas>
  <h1 id="title" class="title">Beckn Protocol</h1>
</section>


<script>
gsap.registerPlugin(ScrollTrigger);

const canvas = document.getElementById("hero-lightpass");
const context = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);


// =====================
// FRAMES
// =====================
const frameCount = 50;

const currentFrame = i =>
  encodeURI(
    `images/sequence/Beckn landing fold - png sequence${String(i).padStart(3,'0')}.png`
  );

const images = [];
const seq = { frame: 0 };

for(let i=0;i<frameCount;i++){
  const img = new Image();
  img.src = currentFrame(i);
  images.push(img);
}
// const frameCount = 124;

// const images = [];

// for(let i=1;i<=frameCount;i++){
//   const img = new Image();
//   img.src = `images/sequences/Image_${String(i).padStart(3,'0')}.jpg`;
//   images.push(img);
// }

// =====================
// RENDER
// =====================
// function render(){
//   const img = images[seq.frame];
//   context.clearRect(0,0,canvas.width,canvas.height);
//   context.drawImage(img,0,0,canvas.width,canvas.height);

//   // SHOW TEXT ONLY AT LAST FRAMES
//   const title = document.getElementById("title");

//   if(seq.frame > frameCount - 5){
//     title.style.opacity = 1;
//     title.style.transform = "translateX(-50%) translateY(-20px)";
//   } else {
//     title.style.opacity = 0;
//   }
// }
let targetFrame = 0;
let currentFrameSmooth = 0;

function render(){

  // smooth interpolation (lerp)
  currentFrameSmooth += (targetFrame - currentFrameSmooth) * 0.15;

  const frameIndex = Math.round(currentFrameSmooth);

  const img = images[frameIndex];

  context.clearRect(0,0,canvas.width,canvas.height);
  context.drawImage(img,0,0,canvas.width,canvas.height);

  // show text near last frame
  const title = document.getElementById("title");

  if(frameIndex > frameCount - 5){
    title.style.opacity = 1;
  } else {
    title.style.opacity = 0;
  }

  requestAnimationFrame(render);
}


images[0].onload = render;
render();

// =====================
// SCROLL SCRUB + PIN
// =====================
// gsap.to(seq,{
//   frame: frameCount-1,
// //   snap:"frame",
//   ease:"none",
//   onUpdate: render,
//   scrollTrigger:{
//     trigger:".sequence",
//     start:"top top",
//     end:"+=1500",
//     scrub:true,
//     pin:true
//   }
// });
gsap.to({}, {
  scrollTrigger:{
    trigger:".sequence",
    start:"top top",
    end:"+=1500",
    scrub:true,
    pin:true,
    onUpdate:self=>{
      targetFrame = self.progress * (frameCount-1);
    }
  }
});


// =====================
// TEXT LAST FRAME ONLY
// =====================
// gsap.to("#title",{
//   opacity:1,
//   y:-20,
//   scrollTrigger:{
//     trigger:".sequence",
//     start:"90%",
//     end:"100%",
//     scrub:true
//   }
// });
</script>

</body>
</html>
